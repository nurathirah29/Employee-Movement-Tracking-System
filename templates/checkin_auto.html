<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Check-In Confirmation</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-align: center;
      padding: 20px;
    }
    .container {
      background: rgba(255,255,255,0.15);
      padding: 40px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      max-width: 400px;
      width: 100%;
      animation: fadeIn 0.5s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    h1 { 
      margin: 0 0 20px; 
      font-size: 2em; 
    }
    .spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .message {
      font-size: 1.1em;
      margin-top: 15px;
      line-height: 1.5;
    }
    .info-box {
      background: rgba(255,255,255,0.2);
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
    }
    .info-box p {
      margin: 8px 0;
      font-size: 1em;
    }
    .info-box strong {
      font-size: 1.1em;
    }
    .error {
      color: #ffcccc;
    }
    .success {
      color: #a8ffb8;
    }
    .btn {
      display: inline-block;
      margin: 10px 5px;
      padding: 12px 24px;
      background: white;
      color: #667eea;
      text-decoration: none;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .btn:hover {
      background: #f1f1f1;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .btn-cancel {
      background: rgba(255,255,255,0.3);
      color: white;
    }
    .btn-cancel:hover {
      background: rgba(255,255,255,0.4);
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #loading-screen, #confirmation-screen, #result-screen {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Loading Screen -->
    <div id="loading-screen">
      <h1>Checking Session...</h1>
      <div class="spinner"></div>
      <p class="message">Please wait...</p>
    </div>

    <!-- Confirmation Screen -->
    <div id="confirmation-screen">
      <h1>✅ Confirm Check-In</h1>
      <div class="info-box" id="employee-info">
        <p><strong>Employee No: <span id="employee-no"></span></strong></p>
        <p><strong>Department: <span id="employee-dept"></span></strong></p>
      </div>
      <p class="message">Do you want to check in now?</p>
      <div>
        <button class="btn" id="confirm-btn" onclick="confirmCheckin()">Yes, Check In</button>
        <button class="btn btn-cancel" onclick="window.location.reload()">Cancel</button>
      </div>
    </div>

    <!-- Result Screen -->
    <div id="result-screen">
      <h1 id="result-title">Processing...</h1>
      <div class="spinner" id="result-spinner"></div>
      <p class="message" id="result-message"></p>
      <p class="message" id="duration-message" style="font-size: 1.3em; font-weight: bold; margin-top: 10px;"></p>
    </div>
  </div>

  <script>
    const loadingScreen = document.getElementById('loading-screen');
    const confirmationScreen = document.getElementById('confirmation-screen');
    const resultScreen = document.getElementById('result-screen');
    const resultSpinner = document.getElementById('result-spinner');
    const resultTitle = document.getElementById('result-title');
    const resultMessage = document.getElementById('result-message');
    const confirmBtn = document.getElementById('confirm-btn');

    let employeeNo = null;

    async function checkSession() {
      loadingScreen.style.display = 'block';

      try {
        const sessionRes = await fetch('/session-status');
        const sessionData = await sessionRes.json();

        if (!sessionData.active) {
          // Session not found - show helpful error
          loadingScreen.style.display = 'none';
          resultScreen.style.display = 'block';
          resultSpinner.style.display = 'none';
          resultTitle.textContent = '⚠️ Session Not Found';
          resultMessage.innerHTML = `
            Your automatic check-in session couldn’t be found.<br><br>
            This might happen if:<br>
            • You’re using a new device<br>
            • Browser cookies were cleared<br>
            • Your session expired<br><br>
            Please proceed with manual check-in.
          `;
          resultMessage.className = 'message error';

          // Add manual check-in button
          const btnContainer = document.createElement('div');
          btnContainer.style.marginTop = '20px';
          btnContainer.innerHTML = `
            <button class="btn" onclick="window.location.href='/checkin-form'" style="width: 100%;">
              Go to Manual Check-In
            </button>
          `;
          document.querySelector('.container').appendChild(btnContainer);
          return;
        }
        
        employeeNo = sessionData.Employee_no;

        // Fetch employee details
        const empRes = await fetch(`/employee/${employeeNo}`);
        const empData = await empRes.json();

        if (empRes.ok) {
          document.getElementById('employee-no').textContent = empData.Employee_no;
          document.getElementById('employee-dept').textContent = empData.Department;
        } else {
          document.getElementById('employee-no').textContent = employeeNo;
          document.getElementById('employee-dept').textContent = 'N/A';
        }

        // Show confirmation screen
        loadingScreen.style.display = 'none';
        confirmationScreen.style.display = 'block';

      } catch (err) {
        console.error('Session check error:', err);
        showError('Network error. Please try again.');
      }
    }

    async function confirmCheckin() {
      if (!employeeNo) return;

      confirmBtn.disabled = true;
      confirmationScreen.style.display = 'none';
      resultScreen.style.display = 'block';
      resultSpinner.style.display = 'block';
      resultTitle.textContent = '⏳ Checking In...';
      resultMessage.textContent = 'Please wait...';
      resultMessage.className = 'message';

      const durationMessage = document.getElementById('duration-message');

      try {
        const res = await fetch(`/checkin/${employeeNo}`, {
          method: 'PUT'
        });

        resultSpinner.style.display = 'none';

        if (res.ok) {
          const data = await res.json();

          resultTitle.textContent = '✅ Success!';
          resultMessage.textContent = 'Checked in successfully! Welcome back!';
          resultMessage.className = 'message success';

          if (data.duration) {
            durationMessage.textContent = `⏱️ Duration: ${data.duration}`;
            durationMessage.className = 'message success';
          }
        } else {
          const data = await res.json();
          
          resultTitle.textContent = '❌ Check-In Failed';
          resultMessage.textContent = data.error || 'Check-in failed';
          resultMessage.className = 'message error';
        }
      } catch (err) {
        console.error('Check-in error:', err);
        resultSpinner.style.display = 'none';
        
        resultTitle.textContent = '❌ Error';
        resultMessage.textContent = 'Network error. Please try again.';
        resultMessage.className = 'message error';
      }
    }

    function showError(msg) {
      loadingScreen.style.display = 'none';
      resultScreen.style.display = 'block';
      resultSpinner.style.display = 'none';
      resultTitle.textContent = '❌ Error';
      resultMessage.textContent = msg;
      resultMessage.className = 'message error';
    }

    // Start session check on page load
    checkSession();
  </script>
</body>
</html>